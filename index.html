<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>English Quiz</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#0f1020; --bg2:#1a1c34; --card:#16182a; --text:#e9ecff;
      --muted:#aeb6d9; --primary:#5b8cff; --primary-2:#4b78e6; --success:#2ecc71; --error:#ff4d4f;
      --glass:rgba(255,255,255,.06); --shadow: 0 20px 60px rgba(0,0,0,.35);
      --outline: rgba(255,255,255,.15);
    }
    .light{
      --bg1:#f7f9ff; --bg2:#e9efff; --card:#ffffff; --text:#0e1328;
      --muted:#4c5572; --primary:#335dff; --primary-2:#234bf0; --success:#19a05b; --error:#e13b3d;
      --glass:rgba(0,0,0,.04); --shadow: 0 12px 40px rgba(18, 32, 68, .12);
      --outline: rgba(0,0,0,.1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 100% -20%, #2f3a85 0%, transparent 60%),
        radial-gradient(1000px 700px at -10% 120%, #1b7dff 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      transition: background .4s ease, color .3s ease;
    }

    /* Navbar */
    .nav{
      position:fixed; inset-inline:0; top:0; z-index:30;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 22px;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,.08));
      border-bottom:1px solid var(--outline);
    }
    .light .nav{
      background: linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.4));
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px}
    .brand-badge{width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg,var(--primary),#7aa8ff); box-shadow: inset 0 0 0 2px rgba(255,255,255,.2)}
    /* Hiding nav actions as requested */
    .nav-actions { display: none; }
    .btn{
      appearance:none; border:1px solid var(--outline); color:var(--text);
      background:linear-gradient(180deg, var(--glass), rgba(255,255,255,0));
      padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
      transition:.2s ease; box-shadow: none;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: var(--shadow)}
    .btn.primary{border-color:transparent; background:linear-gradient(135deg, var(--primary), var(--primary-2)); color:#fff}
    .btn.ghost{background:transparent}
    .chip{
      padding:6px 10px; border-radius:999px; border:1px dashed var(--outline); font-size:.85rem; color:var(--muted)
    }

    /* Layout */
    .container{padding-top:88px; padding-bottom:40px; max-width:1100px; margin:0 auto}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:24px}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
      border: 1px solid var(--outline);
      box-shadow: var(--shadow);
      border-radius: 18px; padding:22px;
    }
    .light .card{background: linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.5));}
    .card-title{margin:0 0 8px; font-size:1.6rem}
    .muted{color:var(--muted)}

    /* Progress */
    .progress-wrap{height:10px; background:rgba(255,255,255,.1); border-radius:999px; overflow:hidden; border:1px solid var(--outline)}
    .progress{height:100%; width:0%; background:linear-gradient(90deg,var(--primary),#6aa6ff); transition: width .35s ease}

    /* Question */
    .question{font-size:1.25rem; margin:14px 0 14px}
    .options{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .options{grid-template-columns:1fr} }
    .opt{
      padding:14px; border-radius:14px; border:1px solid var(--outline);
      background:linear-gradient(180deg, var(--glass), rgba(255,255,255,0));
      cursor:pointer; font-weight:600; text-align:center; transition:.2s ease;
      user-select:none;
    }
    .opt:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
    .opt.correct{background:linear-gradient(135deg, var(--success), #3ee18d); color:#081e12; border-color: transparent}
    .opt.wrong{background:linear-gradient(135deg, var(--error), #ff7a7c); color:#2a0000; border-color: transparent}
    .opt.disabled{pointer-events:none; opacity:.85; filter:grayscale(.07)}

    .explain{margin-top:10px; padding:12px 14px; border-radius:12px; border:1px dashed var(--outline); background:linear-gradient(180deg, var(--glass), rgba(255,255,255,0))}
    .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}

    /* Side panel */
    .side{display:flex; flex-direction:column; gap:18px}
    .stat{display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-radius:12px; border:1px dashed var(--outline)}
    .kpi{font-size:1.4rem; font-weight:800}

    /* Settings */
    /* Adjusting settings container to be a normal section */
    .settings-row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px dashed var(--outline)}
    .switch{width:56px; height:32px; border-radius:999px; background:rgba(255,255,255,.15); border:1px solid var(--outline); position:relative; cursor:pointer}
    .switch::after{content:""; position:absolute; top:3px; left:3px; width:26px; height:26px; border-radius:50%; background:#fff; transition:.25s ease}
    .switch.active{background:linear-gradient(90deg, #111, #333)}
    .switch.active::after{left:27px; background:#000}

    select, input[type="number"]{
      width:180px; padding:10px 12px; border-radius:10px; border:1px solid var(--outline); background:transparent; color:var(--text);
      outline:none;
    }

    /* Modal (Sign in) */
    .overlay{ display:none; }
    .modal {
      width:min(520px, 92vw); border-radius:18px; position:relative;
    }
    .tabs{display:flex; gap:8px; margin:4px 0 12px}
    .tab{flex:1; text-align:center; padding:10px; border-radius:12px; border:1px solid var(--outline); cursor:pointer; font-weight:700}
    .tab.active{background:linear-gradient(135deg, var(--primary), var(--primary-2)); color:#fff; border-color: transparent}
    .field{display:flex; align-items:center; gap:10px; margin:8px 0}
    .field input{
      flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--outline);
      background:transparent; color:var(--text); outline:none;
    }
    .x{position:absolute; top:10px; inset-inline-end:12px; background:transparent; border:none; font-size:20px; color:var(--muted); cursor:pointer}

    /* Result circle */
    .ring{width:160px; height:160px}
    .center{display:flex; align-items:center; justify-content:center}

    /* Toast */
    .toast{
      position:fixed; bottom:18px; inset-inline:0; margin:auto; width:fit-content;
      background:#111; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transform:translateY(6px);
      transition:.25s ease; z-index:60
    }
    .toast.show{opacity:1; transform:translateY(0)}
    .light .toast{background:#222; color:#fff}

    /* Copyright */
    .copyright {
      text-align: center;
      margin-top: 40px;
      color: var(--muted);
      font-size: 0.9rem;
    }
  </style>
</head>

<body class="">
  <nav class="nav">
    <div class="brand">
      <div class="brand-badge"></div>
      <div>English Quiz</div>
    </div>
    <div class="nav-actions">
    </div>
    </nav>

  <main class="container">
    <div class="grid">
      <section class="card" id="quizCard" aria-live="polite">
        <h2 class="card-title">My website nourğŸ«£ğŸ‘‘</h2>
        <div class="muted" id="status">Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="qIndex">1</span> Ù…Ù† <span id="qTotal">10</span></div>

        <div class="progress-wrap" style="margin:12px 0 18px">
          <div id="progress" class="progress"></div>
        </div>

        <div class="question" id="questionText">...</div>
        <div class="options" id="options"></div>

        <div class="explain" id="explain" style="display:none"></div>

        <div class="actions">
          <button id="btnNext" class="btn primary" style="display:none">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
      </section>

      <aside class="side">
        <section class="card">
          <h3 class="card-title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
          <div class="stat"><span>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span><span class="kpi" id="scoreKpi">0</span></div>
          <div class="stat"><span>Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ¨Ù‚ÙŠØ©</span><span class="kpi" id="leftKpi">0</span></div>
          <div class="stat"><span>Ø§Ù„ÙˆØ¶Ø¹</span><span class="kpi" id="themeKpi">Dark</span></div>
        </section>

        <section class="card">
          <h3 class="card-title">Ù…Ø¹Ù„ÙˆÙ…Ù‡ Ø³Ø±ÙŠØ¹Ù‡</h3>
          <ul class="muted" style="margin:0 0 0 18px; line-height:1.9">
            <li>Ø·ÙˆÙ„ Ù…Ø§ Ø§Ù†Øª ÙÙŠ Ù…ÙˆÙ‚Ø¹ÙŠ Ù‡ØªØ´ÙˆÙ Ø§Ù„Ø¹Ø¬Ø§Ø¦Ø¨ ğŸ™‚ğŸ‘‘.</li>
          </ul>
        </section>

        <section class="card" id="resultCard" style="display: none;">
          <h3 class="card-title">Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
          <div class="center" style="margin:12px 0 10px">
            <svg class="ring" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="rgba(255,255,255,.15)" stroke-width="12"/>
              <circle id="ringProgress" cx="60" cy="60" r="52" fill="none" stroke="url(#g)" stroke-width="12" stroke-linecap="round" stroke-dasharray="327" stroke-dashoffset="327" transform="rotate(-90 60 60)"/>
              <defs>
                <linearGradient id="g" x1="0" x2="1">
                  <stop offset="0" stop-color="var(--primary)"/>
                  <stop offset="1" stop-color="#6aa6ff"/>
                </linearGradient>
              </defs>
            </svg>
          </div>
          <div style="font-size:2rem; font-weight:800" id="scoreText">0%</div>
          <div class="muted" id="scoreDetail">0 / 0</div>
          <div class="actions" style="justify-content:center; margin-top:16px">
            <button id="btnRetry" class="btn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
            <button id="btnGoSettings" class="btn">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          </div>
        </section>
      </aside>
    </div>

    <div style="margin-top: 40px;" class="grid">
      <section class="card" id="settingsCard">
        <h3 class="card-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <div class="settings-row">
          <div>
            <div style="font-weight:700">Ø§Ù„ÙˆØ¶Ø¹</div>
            <div class="muted">ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Light / Dark</div>
          </div>
          <div id="themeSwitch" class="switch" role="switch" aria-checked="false"></div>
        </div>
        <div class="settings-row">
          <div>
            <div style="font-weight:700">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
            <div class="muted">Ø§Ø®ØªØ± 5 Ø£Ùˆ 10 Ø£Ùˆ 20 Ø³Ø¤Ø§Ù„</div>
          </div>
          <select id="countSelect">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
          </select>
        </div>
        <div class="settings-row">
          <div>
            <div style="font-weight:700">Ù…Ø³Ø­ Ø§Ù„ØªÙ‚Ø¯Ù…</div>
            <div class="muted">Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙØ¬Ø§Ø¨Ø© ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©</div>
          </div>
          <button id="btnClear" class="btn">Ù…Ø³Ø­</button>
        </div>
        <div class="actions" style="justify-content:flex-end; margin-top:18px">
          <button id="btnSaveSettings" class="btn primary">Ø­ÙØ¸</button>
        </div>
      </section>

      <section class="card" id="authCard">
        <div id="authSection">
          <h3 class="card-title" style="margin-bottom:6px">Sign in</h3>
          <div class="tabs">
            <button id="tabLogin" class="tab active">Login</button>
            <button id="tabCreate" class="tab">Create Account</button>
          </div>
          <div id="loginForm">
            <div class="field"><input id="loginUser" placeholder="Username" autocomplete="username"></div>
            <div class="field"><input id="loginPass" placeholder="Password" type="password" autocomplete="current-password"></div>
            <div class="actions" style="justify-content:space-between">
              <button id="btnGuest" class="btn">Continue as Guest</button>
              <button id="btnDoLogin" class="btn primary">Login</button>
            </div>
          </div>
          <div id="createForm" style="display:none">
            <div class="field"><input id="createUser" placeholder="Username" autocomplete="off"></div>
            <div class="field"><input id="createEmail" placeholder="Email" type="email" autocomplete="off"></div>
            <div class="field"><input id="createPass" placeholder="Password" type="password" autocomplete="new-password"></div>
            <div class="actions" style="justify-content:flex-end">
              <button id="btnDoCreate" class="btn primary">Create</button>
            </div>
          </div>
        </div>

        <div id="logoutSection" style="display: none;">
          <h3 class="card-title">User: <span id="currentUserName">Guest</span></h3>
          <div class="actions" style="justify-content:flex-end">
            <button id="btnLogout" class="btn">Logout</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="copyright">
    &copy; 2025 Nour. ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
  </footer>

  <div class="toast" id="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸</div>

  <script>
    /************* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (20 Ø³Ø¤Ø§Ù„) *************/
    const ALL_QUESTIONS = [
      {id:1,  q:"What is the synonym of 'Happy'?", opts:["Sad","Joyful","Angry","Afraid"], a:1, ex:"'Joyful' is a synonym of 'Happy'."},
      {id:2,  q:"Choose the correct past of 'Go'.", opts:["Goed","Went","Goes","Going"], a:1, ex:"Past of 'go' is 'went'."},
      {id:3,  q:"Fill in: ___ apple", opts:["A","An","The","No article"], a:1, ex:"Use 'An' before vowel sound."},
      {id:4,  q:"Opposite of 'Big'?", opts:["Tiny","Huge","Large","Tall"], a:0, ex:"'Tiny' is antonym of 'Big'."},
      {id:5,  q:"Plural of 'Child'?", opts:["Childs","Children","Childes","Childer"], a:1, ex:"Correct plural is 'Children'."},
      {id:6,  q:"Choose the correct: She ___ to music.", opts:["listening","listen","listens","listened"], a:2, ex:"She + verb(s) â†’ 'listens'."},
      {id:7,  q:"Which is an adjective?", opts:["Quickly","Happiness","Quick","Quickness"], a:2, ex:"'Quick' is adjective."},
      {id:8,  q:"'They ___ football every week.'", opts:["play","plays","played","playing"], a:0, ex:"Present simple plural â†’ 'play'."},
      {id:9,  q:"Choose preposition: 'interested ___ art'", opts:["on","in","at","for"], a:1, ex:"'Interested in'."},
      {id:10, q:"Comparative of 'good'?", opts:["gooder","more good","better","best"], a:2, ex:"good â†’ better â†’ best."},
      {id:11, q:"Past of 'eat'?", opts:["ate","eated","eat","eaten"], a:0, ex:"Past simple â†’ 'ate'."},
      {id:12, q:"Correct tag: 'You are coming, ___?'", opts:["isn't you","aren't you","don't you","are you"], a:1, ex:"Be-verb â†’ 'aren't you'."},
      {id:13, q:"Choose article: ___ Nile is long.", opts:["A","An","The","â€”"], a:2, ex:"Unique rivers take 'The'."},
      {id:14, q:"'He has ___ friends.'", opts:["much","many","little","few"], a:1, ex:"Countable plural â†’ many."},
      {id:15, q:"Choose: 'If it rains, we ___ home.'", opts:["stay","stayed","will stay","stays"], a:2, ex:"First conditional â†’ will stay."},
      {id:16, q:"Gerund form of 'swim'?", opts:["swim","swims","swimming","swammed"], a:2, ex:"Verb+ing â†’ swimming."},
      {id:17, q:"Which is a noun?", opts:["beauty","beautiful","beautifully","beautified"], a:0, ex:"'beauty' is noun."},
      {id:18, q:"Choose tense: 'I have finished.'", opts:["Present simple","Present perfect","Past simple","Future"], a:1, ex:"'have + pp' â†’ present perfect."},
      {id:19, q:"Right order: 'never / I / late / am'", opts:["I am never late","I never am late","Am I never late","Never I am late"], a:0, ex:"Subject-verb order."},
      {id:20, q:"Meaning of 'expand'?", opts:["shrink","enlarge","close","ignore"], a:1, ex:"Expand = enlarge."}
    ];

    /************* Ø§Ù„ØªØ®Ø²ÙŠÙ† *************/
    const LS_KEY_USERS = "quiz_users_v1";
    const LS_KEY_CURRENT = "quiz_current_v1";
    const DEFAULT_SETTINGS = { theme:"dark", count:10, answered:[] };

    const $ = (q) => document.querySelector(q);
    const $$ = (q) => document.querySelectorAll(q);

    const state = {
      user: null,              // {username, settings{theme,count,answered[]}}
      sessionQuestions: [],    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø¬Ù„Ø³Ø©
      index: 0,
      score: 0,
    };

    function loadUsers(){ return JSON.parse(localStorage.getItem(LS_KEY_USERS) || "{}"); }
    function saveUsers(obj){ localStorage.setItem(LS_KEY_USERS, JSON.stringify(obj)); }
    function getCurrent(){ return localStorage.getItem(LS_KEY_CURRENT) || null; }
    function setCurrent(u){ if(u) localStorage.setItem(LS_KEY_CURRENT,u); else localStorage.removeItem(LS_KEY_CURRENT); }

    function ensureUser(username){
      const users = loadUsers();
      if(!users[username]){
        users[username] = { password:"", email:"", settings: JSON.parse(JSON.stringify(DEFAULT_SETTINGS)) };
        saveUsers(users);
      }
      return users[username];
    }
    function updateUser(username, data){
      const users = loadUsers();
      users[username] = {...users[username], ...data};
      saveUsers(users);
      }
    function updateUserSettings(patch){
      const users = loadUsers();
      const u = state.user?.username;
      if(!u) return;
      users[u].settings = { ...users[u].settings, ...patch };
      saveUsers(users);
      state.user.settings = users[u].settings;
    }

    /************* ÙˆØ§Ø¬Ù‡Ø© *************/
    const elements = {
      qIndex: $("#qIndex"), qTotal: $("#qTotal"), progress: $("#progress"),
      question: $("#questionText"), options: $("#options"), explain: $("#explain"),
      scoreKpi: $("#scoreKpi"), leftKpi: $("#leftKpi"), themeKpi: $("#themeKpi"),
      btnNext: $("#btnNext"),
      btnSettings: $("#btnSettings"), settingsCard: $("#settingsCard"),
      themeSwitch: $("#themeSwitch"), countSelect: $("#countSelect"),
      btnSaveSettings: $("#btnSaveSettings"), btnClear: $("#btnClear"),
      authCard: $("#authCard"), authSection: $("#authSection"), logoutSection: $("#logoutSection"),
      tabLogin: $("#tabLogin"), tabCreate: $("#tabCreate"), loginForm: $("#loginForm"), createForm: $("#createForm"),
      loginUser: $("#loginUser"), loginPass: $("#loginPass"),
      createUser: $("#createUser"), createEmail: $("#createEmail"), createPass: $("#createPass"),
      btnDoLogin: $("#btnDoLogin"), btnDoCreate: $("#btnDoCreate"), btnGuest: $("#btnGuest"),
      currentUserName: $("#currentUserName"), btnLogout: $("#btnLogout"),
      resultCard: $("#resultCard"), ringProgress: $("#ringProgress"), scoreText: $("#scoreText"), scoreDetail: $("#scoreDetail"),
      btnRetry: $("#btnRetry"), btnGoSettings: $("#btnGoSettings"),
      toast: $("#toast"),
      status: $("#status"),
    };

    function toast(msg){
      elements.toast.textContent = msg;
      elements.toast.classList.add("show");
      setTimeout(()=>elements.toast.classList.remove("show"), 1900);
    }

    /************* ØªÙŠÙ…/ÙˆØ¶Ø¹ *************/
    function applyTheme(theme){
      if(theme === "light"){ document.body.classList.add("light"); elements.themeKpi.textContent = "Light"; }
      else { document.body.classList.remove("light"); elements.themeKpi.textContent = "Dark"; }
      const active = theme !== "light";
      elements.themeSwitch.classList.toggle("active", active);
      elements.themeSwitch.setAttribute("aria-checked", active ? "true" : "false");
      // persist
      if(state.user && state.user.username){
        updateUserSettings({ theme });
      }
    }

    /************* Ø§Ø®ØªÙŠØ§Ø± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± *************/
    function pickSessionQuestions(){
      const { count, answered } = state.user.settings;
      // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙØ¬Ø§Ø¨Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§
      const pool = ALL_QUESTIONS.filter(q => !answered.includes(q.id));
      if(pool.length === 0){
        toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© â€” Ø§Ù…Ø³Ø­ Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
        elements.question.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ù…Ø³Ø­ Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ ØºÙŠÙ‘Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.";
        elements.options.innerHTML = "";
        elements.btnNext.style.display = "none";
        elements.qTotal.textContent = 0;
        elements.qIndex.textContent = 0;
        elements.leftKpi.textContent = 0;
        return;
      }
      // Ù„Ùˆ Ø§Ù„Ù…ØªØ§Ø­ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŒ Ù‡Ù†Ø³ØªØ®Ø¯Ù… ÙƒÙ„ Ø§Ù„Ù…ØªØ§Ø­
      const target = Math.min(count, pool.length);
      // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
      const shuffled = pool.sort(()=>Math.random()-0.5).slice(0, target);
      state.sessionQuestions = shuffled;
      state.index = 0;
      state.score = 0;
      elements.resultCard.style.display = "none";
      elements.qTotal.textContent = target;
      updateKpis();
      renderQuestion();
    }

    function updateKpis(){
      const left = Math.max(0, state.sessionQuestions.length - state.index);
      elements.leftKpi.textContent = left;
      elements.scoreKpi.textContent = state.score;
      const pct = (state.index / Math.max(state.sessionQuestions.length,1)) * 100;
      elements.progress.style.width = pct + "%";
      elements.qIndex.textContent = state.sessionQuestions.length ? Math.min(state.index + 1, state.sessionQuestions.length) : 0;
      elements.status.style.display = state.sessionQuestions.length ? "block" : "none";
    }

    function renderQuestion(){
      const q = state.sessionQuestions[state.index];
      if(!q){ showResult(); return; }
      elements.explain.style.display = "none";
      elements.btnNext.style.display = "none";
      elements.question.textContent = q.q;
      elements.options.innerHTML = "";
      q.opts.forEach((txt, i)=>{
        const b = document.createElement("button");
        b.className = "opt";
        b.textContent = txt;
        b.onclick = ()=> selectAnswer(i);
        elements.options.appendChild(b);
      });
    }

    function selectAnswer(i){
      const q = state.sessionQuestions[state.index];
      const btns = [...elements.options.children];
      btns.forEach(b => b.classList.add("disabled"));

      if(i === q.a){
        btns[i].classList.add("correct");
        state.score++;
        elements.explain.textContent = "âœ… " + q.ex;
      }else{
        btns[i].classList.add("wrong");
        btns[q.a]?.classList.add("correct");
        elements.explain.textContent = "âŒ " + q.ex;
      }
      elements.explain.style.display = "block";
      elements.btnNext.style.display = "inline-block";

      // Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙƒÙ€ Ù…ÙØ¬Ø§Ø¨ Ø¹Ù„ÙŠÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      const ans = state.user.settings.answered;
      if(!ans.includes(q.id)){
        ans.push(q.id);
        updateUserSettings({ answered: ans });
      }
      // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… (score + index) Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      updateUserSettings({ lastScore: state.score, lastIndex: state.index });
      updateKpis();
    }

    function nextQuestion(){
      state.index++;
      updateKpis();
      if(state.index >= state.sessionQuestions.length) showResult();
      else renderQuestion();
    }

    /************* Ù†ØªÙŠØ¬Ø© *************/
    function showResult(){
      const total = state.sessionQuestions.length || 1;
      const pct = Math.round((state.score / total) * 100);
      elements.scoreText.textContent = pct + "%";
      elements.scoreDetail.textContent = `${state.score} / ${total}`;
      const full = 2 * Math.PI * 52; // Ù…Ø­ÙŠØ· Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
      const offset = full * (1 - pct/100);
      elements.ringProgress.style.strokeDashoffset = String(offset);
      elements.resultCard.style.display = "block";
      // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      updateUserSettings({ lastResult: { score: state.score, total } });
    }

    /************* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª *************/
    function saveSettings(){
      const count = Number(elements.countSelect.value);
      const theme = document.body.classList.contains("light") ? "light" : "dark";
      updateUserSettings({ count, theme });
      applyTheme(theme);
      toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      pickSessionQuestions();
    }

    function clearProgress(){
      updateUserSettings({ answered: [], lastScore:0, lastIndex:0, lastResult:null });
      toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªÙ‚Ø¯Ù…");
      pickSessionQuestions();
    }

    /************* Ù…ØµØ§Ø¯Ù‚Ø© *************/
    function applyCurrentUser(){
      const username = getCurrent();
      if(!username){
        // Ø¶ÙŠÙ Ù…Ø³ØªØ®Ø¯Ù… guest
        const u = ensureUser("guest");
        setCurrent("guest");
        state.user = { username:"guest", settings: u.settings };
      }else{
        const users = loadUsers();
        if(!users[username]) ensureUser(username);
        state.user = { username, settings: users[username].settings };
      }

      // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
      elements.currentUserName.textContent = state.user.username;

      // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if(state.user.username && state.user.username !== "guest"){
        elements.authSection.style.display = "none";
        elements.logoutSection.style.display = "block";
      } else {
        elements.authSection.style.display = "block";
        elements.logoutSection.style.display = "none";
      }

      // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
      elements.tabCreate.style.display = state.user.username === "guest" ? "inline-block" : "none";
      elements.btnDoCreate.style.display = state.user.username === "guest" ? "inline-block" : "none";

      // Ø·Ø¨Ù‘Ù‚ Ø§Ù„Ø«ÙŠÙ… (Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
      applyTheme(state.user.settings.theme || "dark");

      // Ù„Ùˆ ÙÙŠÙ‡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù†Ø¹Ø±Ø¶Ù‡Ø§
      if(state.user.settings.count){
        elements.countSelect.value = String(state.user.settings.count);
      }

      // Ø§Ø¨Ù†ÙŠ Ø¬Ù„Ø³Ø©
      pickSessionQuestions();
    }

    function login(username, password){
      username = (username || "").trim();
      password = (password || "").trim();
      const users = loadUsers();
      if(!users[username]) return toast("Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      if(users[username].password !== password) return toast("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      setCurrent(username);
      state.user = { username, settings: users[username].settings };
      toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      applyCurrentUser();
    }

    function createAccount(username, email, password){
      username = (username || "").trim();
      email = (email || "").trim();
      password = (password || "").trim();
      if(username.length < 3) return toast("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚ØµÙŠØ±");
      const users = loadUsers();
      if(users[username]) return toast("Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„");
      users[username] = { password, email, settings: JSON.parse(JSON.stringify(DEFAULT_SETTINGS)) };
      saveUsers(users);
      setCurrent(username);
      state.user = { username, settings: users[username].settings };
      toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
      applyCurrentUser();
    }

    function logout(){
      setCurrent(null);
      toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
      applyCurrentUser();
    }

    /************* Ø£Ø­Ø¯Ø§Ø« UI *************/
    // Next
    elements.btnNext.addEventListener("click", nextQuestion);

    // Settings save/clear
    elements.btnSaveSettings.addEventListener("click", saveSettings);
    elements.btnClear.addEventListener("click", clearProgress);
    elements.themeSwitch.addEventListener("click", ()=>{
      const on = !document.body.classList.contains("light");
      applyTheme(on? "light":"dark");
    });

    // Auth tabs/login/create/guest/logout
    elements.tabLogin.addEventListener("click", ()=>{
      elements.tabLogin.classList.add("active"); elements.tabCreate.classList.remove("active");
      elements.loginForm.style.display="block"; elements.createForm.style.display="none";
    });
    elements.tabCreate.addEventListener("click", ()=>{
      elements.tabCreate.classList.add("active"); elements.tabLogin.classList.remove("active");
      elements.createForm.style.display="block"; elements.loginForm.style.display="none";
    });
    elements.btnDoLogin.addEventListener("click", ()=> login(elements.loginUser.value, elements.loginPass.value));
    elements.btnDoCreate.addEventListener("click", ()=> createAccount(elements.createUser.value, elements.createEmail.value, elements.createPass.value));
    elements.btnGuest.addEventListener("click", ()=>{
      setCurrent("guest");
      applyCurrentUser();
    });
    elements.btnLogout.addEventListener("click", logout);

    // Result buttons
    elements.btnRetry.addEventListener("click", ()=>{
      pickSessionQuestions();
    });
    elements.btnGoSettings.addEventListener("click", ()=>{
      document.getElementById('settingsCard').scrollIntoView({ behavior: 'smooth' });
    });

    // Utility: load/save users
    function loadUserIfMissing(){
      const users = loadUsers();
      if(Object.keys(users).length === 0){
        // create a default guest user
        users.guest = { password:"", email:"", settings: JSON.parse(JSON.stringify(DEFAULT_SETTINGS)) };
        saveUsers(users);
      }
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    (function init(){
      loadUserIfMissing();
      const first = getCurrent();
      if(!first){
        ensureUser("guest"); setCurrent("guest");
      }
      applyCurrentUser();
    })();
  </script>
</body>
</html>
